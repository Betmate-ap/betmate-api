name: Check Railway Secrets Configuration

on:
  workflow_dispatch:
  schedule:
    # Run daily at 9 AM UTC to check if secrets are still valid
    - cron: "0 9 * * *"

jobs:
  check-secrets:
    name: Validate Railway Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Required Secrets
        id: check-secrets
        run: |
          echo "🔍 Checking Railway secrets configuration..."

          MISSING_SECRETS=""
          CONFIGURED_SECRETS=""

          # Check required secrets
          if [ -z "${{ secrets.RAILWAY_TOKEN }}" ]; then
            MISSING_SECRETS="$MISSING_SECRETS\n❌ RAILWAY_TOKEN"
          else
            CONFIGURED_SECRETS="$CONFIGURED_SECRETS\n✅ RAILWAY_TOKEN"
          fi

          if [ -z "${{ secrets.RAILWAY_PROJECT_ID }}" ]; then
            echo "⚠️ RAILWAY_PROJECT_ID not configured (optional)"
          else
            CONFIGURED_SECRETS="$CONFIGURED_SECRETS\n✅ RAILWAY_PROJECT_ID"
          fi

          # Check optional environment secrets
          OPTIONAL_SECRETS=""
          if [ -n "${{ secrets.STAGING_DATABASE_URL }}" ]; then
            OPTIONAL_SECRETS="$OPTIONAL_SECRETS\n✅ STAGING_DATABASE_URL"
          fi
          if [ -n "${{ secrets.STAGING_JWT_SECRET }}" ]; then
            OPTIONAL_SECRETS="$OPTIONAL_SECRETS\n✅ STAGING_JWT_SECRET"
          fi
          if [ -n "${{ secrets.STAGING_CORS_ORIGIN }}" ]; then
            OPTIONAL_SECRETS="$OPTIONAL_SECRETS\n✅ STAGING_CORS_ORIGIN"
          fi

          echo "📊 Secrets Status Report:"
          echo "========================"

          if [ -n "$CONFIGURED_SECRETS" ]; then
            echo "✅ Configured secrets:"
            echo -e "$CONFIGURED_SECRETS"
          fi

          if [ -n "$OPTIONAL_SECRETS" ]; then
            echo ""
            echo "📦 Optional secrets configured:"
            echo -e "$OPTIONAL_SECRETS"
          fi

          if [ -n "$MISSING_SECRETS" ]; then
            echo ""
            echo "🚨 Missing required secrets:"
            echo -e "$MISSING_SECRETS"
            echo ""
            echo "📋 To fix this:"
            echo "1. Run: railway auth"
            echo "2. Copy the token"
            echo "3. Go to Settings → Secrets and variables → Actions"
            echo "4. Add RAILWAY_TOKEN secret"
            echo ""
            echo "📖 See GITHUB_SECRETS_SETUP.md for detailed instructions"
            echo "setup-needed=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo ""
            echo "🎉 All required secrets are configured!"
            echo "✅ Railway deployments should work correctly"
            echo "setup-needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Test Railway Connection (if secrets configured)
        if: steps.check-secrets.outputs.setup-needed == 'false'
        run: |
          echo "🔌 Testing Railway connection..."
          npm install -g @railway/cli
          railway whoami
          echo "✅ Railway connection successful!"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Setup Instructions
        if: failure()
        run: |
          echo "🛠️ Setup Instructions:"
          echo "====================="
          echo ""
          echo "Your Railway secrets are not configured. Follow these steps:"
          echo ""
          echo "1. 🔑 Get your Railway token:"
          echo "   railway auth"
          echo ""
          echo "2. 🏠 Go to your GitHub repository"
          echo "3. ⚙️ Click Settings → Secrets and variables → Actions"
          echo "4. ➕ Click 'New repository secret'"
          echo "5. 📝 Add RAILWAY_TOKEN with your token"
          echo ""
          echo "📖 Full guide: GITHUB_SECRETS_SETUP.md"
          echo "🚀 After setup, your deployments will work!"

      - name: Summary
        if: always()
        run: |
          echo "📈 Summary:"
          echo "==========="
          if [ "${{ steps.check-secrets.outputs.setup-needed }}" == "true" ]; then
            echo "❌ Setup required - add Railway secrets to continue"
          else
            echo "✅ All good - Railway deployments ready!"
          fi
