name: Setup Railway Configuration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to set up (staging or production)'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  setup:
    name: Setup Railway for ${{ inputs.environment }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Required Secrets
        run: |
          echo "üîç Checking Railway configuration for ${{ inputs.environment }}..."

          MISSING_SECRETS=""

          if [ -z "${{ secrets.RAILWAY_TOKEN }}" ]; then
            MISSING_SECRETS="$MISSING_SECRETS\n- RAILWAY_TOKEN"
          fi

          if [ -z "${{ secrets.RAILWAY_SERVICE_ID }}" ]; then
            MISSING_SECRETS="$MISSING_SECRETS\n- RAILWAY_SERVICE_ID"
          fi

          if [ "${{ inputs.environment }}" == "staging" ] && [ -z "${{ secrets.STAGING_URL }}" ]; then
            MISSING_SECRETS="$MISSING_SECRETS\n- STAGING_URL"
          fi

          if [ "${{ inputs.environment }}" == "production" ] && [ -z "${{ secrets.PRODUCTION_URL }}" ]; then
            MISSING_SECRETS="$MISSING_SECRETS\n- PRODUCTION_URL"
          fi

          if [ -n "$MISSING_SECRETS" ]; then
            echo "‚ùå Missing required secrets:"
            echo -e "$MISSING_SECRETS"
            echo ""
            echo "üìã To fix this:"
            echo "1. Go to Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "2. Add the missing secrets"
            echo ""
            echo "üîß How to get the values:"
            echo "- RAILWAY_TOKEN: Run 'railway auth'"
            echo "- RAILWAY_SERVICE_ID: Run 'railway status'"
            echo "- STAGING_URL/PRODUCTION_URL: Check Railway dashboard"
            exit 1
          fi

          echo "‚úÖ All required secrets are configured!"

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Test Railway Connection
        run: |
          echo "üîå Testing Railway connection..."
          railway whoami
          echo "‚úÖ Railway connection successful!"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Verify Service Access
        run: |
          echo "üîç Verifying service access..."
          railway status --service ${{ secrets.RAILWAY_SERVICE_ID }}
          echo "‚úÖ Service access verified!"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Check Environment
        run: |
          echo "üåç Checking ${{ inputs.environment }} environment..."
          railway environment list --service ${{ secrets.RAILWAY_SERVICE_ID }}
          echo "‚úÖ Environment check complete!"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Setup Complete
        run: |
          echo "üéâ Railway setup complete for ${{ inputs.environment }}!"
          echo ""
          echo "‚úÖ You can now:"
          echo "- Push to 'develop' branch for staging deployment"
          echo "- Push to 'main' branch for production deployment"
          echo "- Run manual deployments with npm scripts"
          echo ""
          echo "üìä Monitor deployments at: https://railway.app"